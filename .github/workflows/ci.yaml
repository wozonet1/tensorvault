name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # 任务 1: 代码质量检查 (静态分析)
  quality:
    name: Quality Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 安装 Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: false # golangci-lint action 自带缓存

      # 安装 Buf (用于生成代码验证)
      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 运行 golangci-lint
      - name: Run GolangCI-Lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

      # 检查 Proto 规范
      - name: Run Buf Lint
        uses: bufbuild/buf-lint-action@v1

  # 任务 2: 测试 (单元测试 + 集成测试)
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    services:
      # 启动 Redis 服务 (集成测试需要)
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install dependencies
        run: go mod download

      - name: Install Protoc Plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # 安装 Buf 工具
      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 生成代码 (现在插件已经装好了，这就不会报错了)
      - name: Generate Protobuf Code
        run: buf generate

      # 运行所有测试 (包含 Race 检测)
      # 注意：我们在 Makefile 里已经排除了 pkg/api，这里直接复用 Makefile
      - name: Run Tests
        run: make test

      # (可选) 运行覆盖率检查
      - name: Check Coverage
        run: make coverage
